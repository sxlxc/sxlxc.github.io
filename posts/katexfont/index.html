<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="googlebot" content="noindex">
    <title>在 KaTeX 中使用 Fira Math</title>
    <link rel="stylesheet" href="../../css/fonts.css" />
    <link rel="stylesheet" href="../../css/default.css" />
    <link rel="stylesheet" href="../../css/pygentize.css" />
    <link rel="stylesheet" href="../../css/chao-theorems.css">
    <link rel="stylesheet" href="../../css/sidenotes.css">
    <script defer src="../../css/pangu.simple.js"></script>
    <script>
        // page title
        document.addEventListener("DOMContentLoaded", function () {
            const hostname = window.location.hostname;
            document.title = document.title + " | " + hostname;
        });

        // pangu
        document.addEventListener('DOMContentLoaded', () => {
            pangu.autoSpacingPage();
        });

        // mathjax
        MathJax = {
            options: {
                menuOptions: {
                    settings: {
                        enrich: false,        // true to enable semantic-enrichment
                        collapsible: false,   // true to enable collapsible math
                        speech: false,        // true to enable speech generation
                        braille: false,       // true to enable Braille generation
                        assistiveMml: false,  // true to enable assistive MathML
                    }
                },
                enableMenu: false
            },
            output: {
                font: 'mathjax-fira',
                fontPath: '/mathjax-fira-font'
            },
            tex: {
                macros: {
                    floor: ["{\\left\\lfloor #1 \\right\\rfloor}", 1],
                    ceil: ["{\\left\\lceil #1 \\right\\rceil}", 1],
                    set: ["{\\left\\{ #1 \\right\\}}", 1],
                    norm: ["{\\left\\| #1 \\right\\|}", 1],
                    F: "{\\mathbb F}",
                    R: "{\\mathbb R}",
                    C: "{\\mathbb C}",
                    Z: "{\\mathbb Z}",
                    e: "{\\varepsilon}",
                    mex: "\\mathop{\\operatorname{mex}}",
                    lcm: "\\mathop{\\operatorname{lcm}}",
                    dist: "\\mathop{\\operatorname{dist}}",
                    poly: "\\mathop{\\operatorname{poly}}",
                    polylog: "\\mathop{\\operatorname{polylog}}",
                    span: "\\mathop{\\operatorname{span}}",
                }
            }
        };
    </script>
    <script defer src="../../mathjax/tex-chtml.js"></script>

</head>

<body>
    <div class="navbar-space">
        
        <!-- A table of contents on the left side, but only for screens
                that are big enough -->
        <div id="contents-big">
            <p class="mini-header">Contents <a id="up-arrow" href="#">↑</a></p>
            <ul>
<li><a href="#katex-字体部分如何工作">KaTeX 字体部分如何工作?</a></li>
<li><a href="#plan">Plan</a></li>
<li><a href="#extract-fonts">Extract fonts</a>
<ul>
<li><a href="#italic">Italic</a></li>
</ul></li>
<li><a href="#接下来">接下来…</a>
<ul>
<li><a href="#typst-svg">Typst svg</a></li>
</ul></li>
<li><a href="#mathjax-4.0-is-out">MathJax 4.0 is out</a></li>
</ul>
        </div>
        
    </div>
    <div class="text-space">
        <header class="no-print">
            <nav class="navbar">
                <a href="../../">Home</a>
                <div class="navright">
                    <a href="../../draft">Drafts</a>
                    <a href="../../about">About</a>
                </div>
            </nav>
        </header>

        <main role="main">
            <h1 class="pagetitle">在 KaTeX 中使用 Fira Math</h1>
            <article>
    <section class="subtitle">
        
        
    </section>
    <section class="header">
        Posted on May 25, 2025
        
            by Yu Cong with help from many others
        
    </section>
    <div class="info">
        
            Tags: <a title="All pages tagged 'katex'." href="../../tags/katex/index.html" rel="tag">katex</a>
        
    </div>    
    <section>
        <blockquote>
<p></p>
现在有一个半成品可用 <a href="https://github.com/congyu711/KaTeX" class="uri">https://github.com/congyu711/KaTeX</a>
</blockquote>
<p></p>
<a href="https://github.com/firamath/firamath">Fira
Math</a>这字体很不错, 想要在KaTeX中使用它.
<p></p>
有用的链接:
<ol type="1">
<li><a href="https://yingtongli.me/blog/2022/09/24/katex-custom-fonts.html" class="uri">https://yingtongli.me/blog/2022/09/24/katex-custom-fonts.html</a>
– alphanumeric text only</li>
<li><a href="https://github.com/KaTeX/KaTeX/discussions/3716" class="uri">https://github.com/KaTeX/KaTeX/discussions/3716</a></li>
<li><a href="https://github.com/firamath/firamath.github.io/blob/master/bibliography.md" class="uri">https://github.com/firamath/firamath.github.io/blob/master/bibliography.md</a></li>
<li><a href="https://learn.microsoft.com/en-us/typography/opentype/spec/math" class="uri">https://learn.microsoft.com/en-us/typography/opentype/spec/math</a></li>
</ol>
<h1 data-number="1" id="katex-字体部分如何工作"><span class="header-section-number">1</span> KaTeX 字体部分如何工作?</h1>
<p></p>
关于fonts和metrics有关的东西首先要看<code>dockers/fonts/</code>. 看起来
<code>fonts/</code>里面的字体是从docker中安装的texlive的computer modern
fonts提取的. 然后<code>dockers/fonts/buildMetrics.sh</code> 调用
<code>src/metrics</code>里面的代码,直接从有关的tfm文件里读一些metric信息.
<p></p>
(我猜)生成的ttf,woff2等字体是保存 unicode -&gt; (字形+一些信息)
这个映射关系的文件. <code>src/metrics/mapping.pl</code> 就是从tex
math到unicode的映射. 做完这个输出这样的东西
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">...</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;AMS-Regular&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;65&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;char&quot;</span><span class="fu">:</span> <span class="dv">65</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;yshift&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;xshift&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;font&quot;</span><span class="fu">:</span> <span class="st">&quot;msbm10&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="er">...</span></span></code></pre></div>
<p></p>
之后输入到<code>src/metrics/extract_tfms.py</code> 得到
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;AMS-Regular&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;65&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;depth&quot;</span><span class="fu">:</span> <span class="fl">0.0</span><span class="fu">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="fl">0.68889</span><span class="fu">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;italic&quot;</span><span class="fu">:</span> <span class="fl">0.0</span><span class="fu">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;skew&quot;</span><span class="fu">:</span> <span class="fl">0.0</span><span class="fu">,</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="fl">0.72222</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="er">...</span></span></code></pre></div>
<p></p>
最后会再做点工作然后把json塞入<code>src/fontMetricsData.js</code>.
我猜如果成功的把Fira Math的metric弄到这个js文件里,
接下来改改css里的字体然后rebuild就行了.
<p></p>
采集metric和生成fonts的过程是独立的, 所以看起来大部分东西都是可以复用的.
<h1 data-number="2" id="plan"><span class="header-section-number">2</span> Plan</h1>
<ol type="1">
<li>由于 KaTeX 本身字体分成很多小文件, 首先我也把 Fira Math
分成小文件</li>
<li>然后想办法搞到正确的 <code>src/metrics/mapping.pl</code> for Fira
Math</li>
<li>最后改改css或者先rebuild再改css之类的.</li>
</ol>
<p></p>
在与 Fira Math 的<a href="https://stone-zeng.site/">作者</a>交流之后意识到:
<ul>
<li>在 1. 中把Fira Math 像computer
modern一样分成小文件可能可以避免让我需要修改大量KaTeX代码.
KaTeX这样做是因为cm在TeX中是<a href="https://en.wikipedia.org/wiki/PostScript_fonts#Type_1">Type 1
font</a>, 单个文件只能容纳256字符.</li>
<li>Fira Math是<a href="https://en.wikipedia.org/wiki/OpenType">Open
Type font</a>. glyph id 到对应字符的 unicode
码位的映射已经包含在了字体的cmap表中. KaTeX生成的html里是unicode字符,
所以我不需要为Fira Math修改<code>src/metrics/mapping.pl</code>,
但是仍然需要对应的<code>src/fontMetricsData.js</code>.</li>
</ul>
<h1 data-number="3" id="extract-fonts"><span class="header-section-number">3</span> Extract fonts</h1>
<p></p>
KaTeX把<code>\mathbb{A} \mathcal{B}</code>
等等符号全部映射到普通拉丁字母A,B上, 这就导致需要在映射的时候做点工作.
而且另一个问题是KaTeX_AMS-Regular等字体在使用 unicode private use
area表示一些unicode中缺少的符号,
比如<code>src/fonts/makeFF</code>中有这样的代码
<div class="sourceCode" id="cb3"><pre class="sourceCode perl"><code class="sourceCode perl"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>    <span class="bn">0x0A</span> =&gt; <span class="bn">0xE010</span>,         <span class="co"># \nleqslant</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="bn">0x0B</span> =&gt; <span class="bn">0xE00F</span>,         <span class="co"># \ngeqslant</span></span></code></pre></div>
<p></p>
因为这些不是我会用的符号, 我决定先不管它.
<p></p>
KaTeX_Main-Regular, KaTeX_Math-Italic.ttf 这些字体表现比较正常,
基本都是Fira Math的子集, 用<a href="https://github.com/congyu711/KaTeX/blob/main/fonts/mimic.py">这里</a>的代码转换.
对于KaTeX_AMS-Regular和KaTeX_Size{k} 这些字体就需要单独处理,
我决定下载fontforge手动处理. <del>Caligraphic 和 Fraktur 字体Fira
Math中也没有覆盖</del>, Fira Math 本来就是sans serif字体,
所以我觉得其他字体都可直接用KaTeX版本.
<h2 data-number="3.1" id="italic"><span class="header-section-number">3.1</span> Italic</h2>
<p></p>
<del>看起来Fira Math字体并无斜体, 查了查貌似TeX是通过OpenType MATH
table来实现斜体, 我需要想想如何搞到Fira Math的斜体版本…</del> 原来Fira
Math是有斜体的,
用fontforge修改比手写unicode映射要简单点(目前只有常用符号做了修改,
很多东西不能正常工作) KaTeX的很多设计让人疑惑,
为什么不做像unicode-math一样的设计, 把所有东西映射到正确的unicode上呢?
又比如<span class="math inline">\(\neq\)</span>,
KaTeX的做法是把一个<span class="math inline">\(=\)</span>和一个类似<span class="math inline">\(\setminus\)</span>的东西组合起来,
而且在字体中这个像<span class="math inline">\(\setminus\)</span>的字符被映射到了private use
area.
<p></p>
<a href="https://firamath.github.io/specimen.html">Fira Math
specimen</a> 有点老旧, 实际上其中很多missing glyph现在已经补上了.
Texlive里的firamath-regular.otf貌似也是旧版本, 比如缺少(0x2216 ∖)
<blockquote>
<p></p>
事实上从 KaTeX 的commit history能看到字体主要是<a href="https://github.com/ylemkimon">ylemkimon</a>的工作.
我发邮件问了问他这些问题, 没有得到回复. 不过我看到<a href="https://www.zhihu.com/question/337382562/answer/766077220">这个知乎回答</a>之后觉得映射问题可能是为了兼容screen
reader? 不过我不觉得这样做就能让screen reader正确读出公式.
另外要谢谢曾祥东老师, 他是Fira Math的主要作者, 读<a href="https://stone-zeng.site/">博客</a>和<a href="https://www.zhihu.com/question/46196562/answer/766203485">介绍FiraMath的知乎回答</a>都让我学到很多东西.
</blockquote>
<p></p>
如果只是更换字体的话, 很多东西看起来有点奇怪
<figure>
<img src="../../images/katexfont/withoutmetric.png" alt="修改字体、没有调整metric" />
<figcaption aria-hidden="true">修改字体、没有调整metric</figcaption>
</figure>
<p></p>
但是我觉得最常用的LP, SDP之类的规划问题显示起来效果还不错
<figure>
<img src="../../images/katexfont/sdptest.png" alt="XeLaTeX 使用 firamath" />
<figcaption aria-hidden="true">XeLaTeX 使用 firamath</figcaption>
</figure>
<p></p>
以下是 mathjax 4.0 的效果
<p></p>
<span class="math display">\[\begin{equation}
\begin{aligned}
\min&amp;   &amp;   \sum_x \delta_x&amp;    &amp;   &amp;\\
s.t.&amp;   &amp;   (1-\delta_x - \delta_y) d^2(x,y)\leq \|v_x-v_y\|^2
&amp;\leq (c^2+(\delta_x+\delta_y)f(k)) d^2(x,y) &amp;   &amp;\forall
x,y\in X\\
    &amp;   &amp;   \delta_x\in [0,1], v_x&amp;\in
\R^p   &amp;   &amp;\forall x\in X
\end{aligned}
\end{equation}\]</span>
<h1 data-number="4" id="接下来"><span class="header-section-number">4</span> 接下来…</h1>
<p></p>
现在<a href="https://typst.app/">Typst</a>看起来是个输出有点排版需求的html内容的好选择.
<a href="https://kawayww.com/posts/example">这里</a>是个例子,
可以看到公式被Typst变成了svg. 效果不错,
但是不知道如果有很多公式的话绘制一堆svg会不会很慢, 页面会不会变得很大.
<p></p>
如果要修改 KaTeX 的话, 我觉得会有很大的工作量. 一方面 KaTeX
本身有点古老, 很多功能的实现方式太局限了. 另一方面我不懂js也不懂排版,
估计需要了解open type字体、<a href="https://ctan.org/pkg/unicode-math?lang=en">unicode-math</a>
的工作方式等.
<!-- 先观察一段时间, Typst的html输出有没有变得更好用, 我有没有闲到会去学和写这个工具. -->
<h2 data-number="4.1" id="typst-svg"><span class="header-section-number">4.1</span> Typst svg</h2>
<p></p>
用这个来让 Typst 在 html 导出中把所有公式都变成 svg.
<pre><code>#show math.equation: html.frame
#show math.equation.where(block: false): box</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">typst</span> compile input.typ <span class="at">-f</span> html htmloutput.html <span class="at">--features</span> html</span></code></pre></div>
<p></p>
测试用的文档是 <a href="https://typst.app/project/rgLBUHLLRwTyTh16Ej3qlM" class="uri">https://typst.app/project/rgLBUHLLRwTyTh16Ej3qlM</a>
<pre><code>+-----------------+-------+
|    outputs      | size  |
+-----------------+-------+
| PDF-XeTeX       | 25KB  |
| PDF-Typst       | 39KB  |
| html-Typst      | 194KB |
| FiraMath font   | 122KB |
+-----------------+-------+</code></pre>
<h1 data-number="5" id="mathjax-4.0-is-out"><span class="header-section-number">5</span> MathJax 4.0 is out</h1>
<p></p>
<a href="https://docs.mathjax.org/en/latest/upgrading/whats-new-4.0.html" class="uri">https://docs.mathjax.org/en/latest/upgrading/whats-new-4.0.html</a>
<p></p>
MathJax 支持 FiraMath. 所以不用再修改 KaTeX.
    </section>
</article>

        </main>

        <footer class="no-print">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
            <a href="https://github.com/congyu711/Hakyllsite">Source</a> on Github.
            License <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0 </a> <img src="../../images/ccbysa.png" alt="Creative Commons License" style="height: 12px; vertical-align: baseline;">

        </footer>
    </div>
</body>

</html>